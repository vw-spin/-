<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Batistone</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/pgadmin.css">
    <style>
        .btn-remover-retrabalho {
            background-color: #dc3545;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .btn-remover-retrabalho:hover {
            background-color: #c82333;
            transform: scale(1.05);
        }

        .btn-remover-retrabalho:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .status-box {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s ease;
        }

        .status-box.com-retrabalho {
            background-color: #fff3cd;
            color: #856404;
            border: 2px solid #ffc107;
        }

        .status-box.sem-retrabalho {
            background-color: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }

        .status-box.erro {
            background-color: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }

        .info-retrabalho {
            margin-top: 10px;
            padding: 10px;
            background-color: #e7f3ff;
            border-left: 4px solid #2196F3;
            border-radius: 4px;
        }

        .info-retrabalho p {
            margin: 5px 0;
            font-size: 14px;
            color: #0d47a1;
        }
    </style>
</head>

<header>
    <div class="container header-content">
        <img src="img/logo.png" alt="Logo Redim" class="logo">
        <div>
            <h3>VW - SPIN 2AP</h3>
        </div>
    </div>
</header>

<body>
    <div id="quadrado">
        <div id="nome">
            <h2>Página de Admin - <span class="vermelho">Mateus S. Batistone</span></h2> </br>
        </div>

        <div class="btn-centro">
            <div class="btn" id="Batistone" onclick="TactoBatistone()"><a><button type="submit">Atualizar</button></a>
            </div>
        </div>

        <div id="roleta-container" style="margin: 20px 0; text-align: center;">
            <h3>Selecionar Código:</h3>
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                <button onclick="roletaAnterior()"
                    style="padding: 10px 20px; font-size: 18px; cursor: pointer;">◀</button>
                <div id="roleta-display"
                    style="font-size: 24px; font-weight: bold; min-width: 100px; padding: 10px; border: 2px solid #333; border-radius: 5px;">
                    0001</div>
                <button onclick="roletaProximo()"
                    style="padding: 10px 20px; font-size: 18px; cursor: pointer;">▶</button>
            </div>
            <p id="roleta-info" style="margin-top: 10px; color: #666;">Código selecionado: 0001</p>
        </div>

        <!-- Botão de Remover Retrabalho -->
        <div class="btn-centro" style="margin-top: 20px;">
            <button class="btn-remover-retrabalho" id="btnRemoverRetrabalho" onclick="removerRetrabalho()">
                ❌ Remover Retrabalho
            </button>
        </div>

        <!-- Status do Código -->
        <div id="statusCodigo" class="status-box sem-retrabalho" style="display: none;">
            ✓ Código sem retrabalho
        </div>

        <!-- Informações adicionais -->
        <div id="infoRetrabalho" class="info-retrabalho" style="display: none;">
            <p><strong>ℹ️ Informações:</strong></p>
            <p id="infoEtapa">Etapa atual: -</p>
            <p id="infoTempo">Tempo estimado: -</p>
        </div>

    </div>
    <div>
        <div id="codigos-container" class="margin">

        </div>
    </div>
    </div>

    <script type="module" src="FireBase/firebase-sync.js"></script>
    <script src="js/codigos.js"></script>
    <script src="js/admin.js"></script>
    <script src="js/rastreamento.js"></script>

    <script>
        // Função para remover o retrabalho
        async function removerRetrabalho() {
            const codigos = JSON.parse(localStorage.getItem("codigos")) || [];
            
            if (codigos.length === 0) {
                mostrarStatus("Nenhum código encontrado!", "erro");
                return;
            }
            
            const codigoStr = String(roletaAtual).padStart(4, '0');
            
            // Verifica se o código existe
            if (!codeExists(codigoStr)) {
                mostrarStatus("Código não encontrado!", "erro");
                return;
            }

            // Verifica se o código tem retrabalho ativo
            let temRetrabalho = false;
            if (window.codigosMap && window.codigosMap[codigoStr]) {
                temRetrabalho = window.codigosMap[codigoStr].retrabalho || false;
            }

            if (!temRetrabalho) {
                mostrarStatus("Este código não está em retrabalho!", "sem-retrabalho");
                return;
            }



            // Remove o retrabalho
            try {
                if (window.updateCodigoRetrabalho && typeof window.updateCodigoRetrabalho === 'function') {
                    await window.updateCodigoRetrabalho(codigoStr, false);
                    console.log(`Retrabalho REMOVIDO do código ${codigoStr}`);
                    mostrarStatus("✅ Retrabalho removido com sucesso!", "sem-retrabalho");
                    atualizarStatusVisual();
                } else {
                    throw new Error("Função de atualização não disponível");
                }
            } catch (error) {
                console.error("Erro ao remover retrabalho:", error);
                mostrarStatus("❌ Erro ao remover retrabalho!", "erro");
            }
        }

        // Função para mostrar status
        function mostrarStatus(mensagem, tipo) {
            const statusBox = document.getElementById('statusCodigo');
            statusBox.innerHTML = mensagem;
            statusBox.className = `status-box ${tipo}`;
            statusBox.style.display = 'block';

            // Oculta após 3 segundos se for mensagem de sucesso
            if (tipo === 'sem-retrabalho' && mensagem.includes('sucesso')) {
                setTimeout(() => {
                    atualizarStatusVisual();
                }, 3000);
            }
        }

        // Função para atualizar o status visual
        function atualizarStatusVisual() {
            const codigoStr = String(roletaAtual).padStart(4, '0');
            const btn = document.getElementById('btnRemoverRetrabalho');
            const statusBox = document.getElementById('statusCodigo');
            const infoBox = document.getElementById('infoRetrabalho');
            const infoEtapa = document.getElementById('infoEtapa');
            const infoTempo = document.getElementById('infoTempo');
            
            // Verifica se o código existe
            if (!codeExists(codigoStr)) {
                statusBox.innerHTML = "⚠️ Código não encontrado";
                statusBox.className = "status-box erro";
                statusBox.style.display = 'block';
                btn.disabled = true;
                infoBox.style.display = 'none';
                return;
            }

            // Verifica o status do retrabalho
            if (window.codigosMap && window.codigosMap[codigoStr]) {
                const codigo = window.codigosMap[codigoStr];
                const temRetrabalho = codigo.retrabalho || false;
                const etapa = codigo.etapa || 0;
                const tempo = codigo.tempo || 0;

                // Atualiza informações
                infoEtapa.textContent = `Etapa atual: ${etapa}/6`;
                infoTempo.textContent = `Tempo estimado: ${formatarTempo(tempo)}`;
                infoBox.style.display = 'block';

                if (temRetrabalho) {
                    statusBox.innerHTML = "⚠️ Código COM RETRABALHO";
                    statusBox.className = "status-box com-retrabalho";
                    btn.disabled = false;
                } else {
                    statusBox.innerHTML = "✓ Código SEM retrabalho";
                    statusBox.className = "status-box sem-retrabalho";
                    btn.disabled = true;
                }
                statusBox.style.display = 'block';
            } else {
                statusBox.innerHTML = "ℹ️ Carregando informações...";
                statusBox.className = "status-box";
                statusBox.style.display = 'block';
                btn.disabled = true;
                infoBox.style.display = 'none';
            }
        }

        // Função para formatar tempo
        function formatarTempo(segundos) {
            const min = Math.floor(segundos / 60);
            const sec = segundos % 60;
            return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        }

        // Monitora mudanças na roleta
        const originalRoletaProximo = window.roletaProximo;
        const originalRoletaAnterior = window.roletaAnterior;

        window.roletaProximo = function() {
            if (originalRoletaProximo) originalRoletaProximo();
            setTimeout(atualizarStatusVisual, 300);
        };

        window.roletaAnterior = function() {
            if (originalRoletaAnterior) originalRoletaAnterior();
            setTimeout(atualizarStatusVisual, 300);
        };

        // Atualiza quando recebe dados do Firebase
        window.addEventListener('firebaseSync:codigos', function() {
            setTimeout(atualizarStatusVisual, 500);
        });

        // Atualiza status inicial
        window.addEventListener('load', function() {
            setTimeout(atualizarStatusVisual, 1000);
        });

        // Atualiza periodicamente
        setInterval(atualizarStatusVisual, 3000);
    </script>

    <br><br>

    <footer>
        <p>&copy; 2025 Redim. Todos os direitos reservados a Matheus Ativo e Maki Yoshitake.</p>
    </footer>
</body>

</html>